<view class="page">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <view class="title-section">
      <text class="main-title">è°ƒæ•´ä»Šæ—¥èœå•</text>
      <text class="date-text">{{todayDate}} {{weekday}}</text>
    </view>
    <view class="changes-indicator" wx:if="{{hasChanges}}">
      <text class="indicator-dot"></text>
      <text class="indicator-text">æœ‰ä¿®æ”¹</text>
    </view>
  </view>

  <!-- è¿‡æ»¤é€‰é¡¹ -->
  <view class="filter-section" wx:if="{{showCandidates}}">
    <view class="filter-header">æ™ºèƒ½æ¨è</view>
    <view class="filter-groups">
      <view class="filter-group">
        <text class="filter-label">èœç³»</text>
        <view class="filter-chips">
          <text class="chip {{filterOptions.cuisine === 'all' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="cuisine" data-value="all">å…¨éƒ¨</text>
          <text class="chip {{filterOptions.cuisine === 'ä¸­å¼' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="cuisine" data-value="ä¸­å¼">ä¸­å¼</text>
          <text class="chip {{filterOptions.cuisine === 'è¥¿å¼' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="cuisine" data-value="è¥¿å¼">è¥¿å¼</text>
        </view>
      </view>
      
      <view class="filter-group">
        <text class="filter-label">æ—¶é•¿</text>
        <view class="filter-chips">
          <text class="chip {{filterOptions.time === 'all' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="time" data-value="all">å…¨éƒ¨</text>
          <text class="chip {{filterOptions.time === 'quick' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="time" data-value="quick">å¿«æ‰‹</text>
        </view>
      </view>
      
      <view class="filter-group">
        <text class="filter-label">æˆæœ¬</text>
        <view class="filter-chips">
          <text class="chip {{filterOptions.cost === 'all' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="cost" data-value="all">å…¨éƒ¨</text>
          <text class="chip {{filterOptions.cost === 'L' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="cost" data-value="L">å®æƒ </text>
          <text class="chip {{filterOptions.cost === 'M' ? 'active' : ''}}" 
                bindtap="setFilter" data-type="cost" data-value="M">ä¸­ç­‰</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å½“å‰èœå• -->
  <view class="menu-section">
    <view class="meal-card" wx:for="{{currentMenu}}" wx:key="name" wx:for-item="meal" wx:for-index="mealIndex">
      <view class="meal-header">
        <view class="meal-info">
          <text class="meal-name">{{meal.name}}</text>
          <text class="meal-people" bindtap="adjustPortion" data-meal-index="{{mealIndex}}">
            {{meal.people.adults}}ä½æˆäºº{{meal.people.kids > 0 ? meal.people.kids + 'ä½å°å­©' : ''}} 
            <text class="adjust-icon">âš™ï¸</text>
          </text>
        </view>
        <view class="meal-actions">
          <button class="action-btn" bindtap="addDish" data-meal-index="{{mealIndex}}">â•</button>
          <button class="action-btn" bindtap="regenerateMeal" data-meal-index="{{mealIndex}}">ğŸ”„</button>
        </view>
      </view>

      <view class="dishes-grid">
        <view class="dish-card {{dish.locked ? 'locked' : ''}}" 
              wx:for="{{meal.dishes}}" wx:key="id" wx:for-item="dish" wx:for-index="dishIndex">
          
          <!-- èœå“ä¿¡æ¯ -->
          <view class="dish-main" bindtap="replaceDish" 
                data-meal-index="{{mealIndex}}" data-dish-index="{{dishIndex}}">
            <text class="dish-emoji">{{dish.emoji || 'ğŸ½ï¸'}}</text>
            <text class="dish-name">{{dish.name}}</text>
            <view class="dish-tags">
              <text class="tag cost-{{dish.cost}}">{{dish.costLabel}}</text>
              <text class="tag">{{dish.time}}åˆ†</text>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="dish-actions">
            <button class="lock-btn {{dish.locked ? 'locked' : ''}}" 
                    bindtap="toggleDishLock" 
                    data-meal-index="{{mealIndex}}" data-dish-index="{{dishIndex}}">
              {{dish.locked ? 'ğŸ”’' : 'ğŸ”“'}}
            </button>
            <button class="remove-btn" wx:if="{{!dish.locked}}"
                    bindtap="removeDish" 
                    data-meal-index="{{mealIndex}}" data-dish-index="{{dishIndex}}">
              âŒ
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å€™é€‰èœå“å¼¹å±‚ -->
  <view class="candidates-overlay" wx:if="{{showCandidates}}" bindtap="closeCandidates">
    <view class="candidates-modal" catchtap="{{true}}">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©æ›¿æ¢èœå“</text>
        <button class="close-btn" bindtap="closeCandidates">âœ•</button>
      </view>
      
      <view class="candidates-grid">
        <view class="candidate-card" 
              wx:for="{{candidateDishes}}" wx:key="id" wx:for-item="dish"
              bindtap="selectCandidate" data-dish="{{dish}}">
          <text class="candidate-emoji">{{dish.emoji}}</text>
          <text class="candidate-name">{{dish.name}}</text>
          <view class="candidate-tags">
            <text class="tag cost-{{dish.cost}}">{{dish.costLabel}}</text>
            <text class="tag">{{dish.time}}åˆ†</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions">
    <button class="cancel-btn" bindtap="cancelChanges" disabled="{{saving}}">
      {{hasChanges ? 'å–æ¶ˆä¿®æ”¹' : 'è¿”å›'}}
    </button>
    <button class="save-btn {{hasChanges ? 'active' : ''}}" 
            bindtap="saveChanges" 
            disabled="{{saving || !hasChanges}}"
            loading="{{saving}}">
      {{saving ? 'ä¿å­˜ä¸­...' : (hasChanges ? 'ä¿å­˜ä¿®æ”¹' : 'æ— ä¿®æ”¹')}}
    </button>
  </view>
</view>