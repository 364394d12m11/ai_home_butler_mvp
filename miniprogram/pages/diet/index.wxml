<!-- pages/diet/index.wxml - V5.3 å®Œç¾ä¿®å¤ç‰ˆ -->
<view class="page">
<!-- å¤´éƒ¨ä¿¡æ¯ -->
<view class="header">
  <view class="date-info">
    <text class="main-title">{{roleConfig[userRole].icon}} {{roleConfig[userRole].title}}</text>
    <text class="date-text">{{todayDate}} {{weekday}}</text>
  </view>
  <text class="subtitle">ä»Šå¤©çš„èœå•ï¼Œæˆ‘å·²ç»å¸®ä½ æ­é…å¥½å•¦ï½</text>
  
  <!-- âœ… V5.3æ–°å¢ï¼šå³ä¸Šè§’é½¿è½®å›¾æ ‡ -->
  <view class="settings-icon" bindtap="goToDietSettings">
    <text class="icon">âš™ï¸</text>
  </view>
</view>

  <!-- V5.3 æ¨¡å¼é€‰æ‹©å™¨ -->
  <view class="mode-selector">
    <view class="mode-tabs">
      <view 
        class="mode-tab {{currentMode === 'æ—¥å¸¸' ? 'active' : ''}}"
        bindtap="switchMode"
        data-mode="æ—¥å¸¸"
      >
        <text class="mode-icon">ğŸ </text>
        <text class="mode-label">æ—¥å¸¸</text>
      </view>
      
      <view 
        class="mode-tab {{currentMode === 'ç›®æ ‡' ? 'active' : ''}}"
        bindtap="switchMode"
        data-mode="ç›®æ ‡"
      >
        <text class="mode-icon">ğŸ¯</text>
        <text class="mode-label">ç›®æ ‡</text>
      </view>
      
      <view 
        class="mode-tab {{currentMode === 'çµæ„Ÿ' ? 'active' : ''}}"
        bindtap="switchMode"
        data-mode="çµæ„Ÿ"
      >
        <text class="mode-icon">âœ¨</text>
        <text class="mode-label">çµæ„Ÿ</text>
      </view>
    </view>
  </view>

<!-- ========== ğŸ”´ æ–°å¢ï¼šç”Ÿæˆèœå•æŒ‰é’® ========== -->
<view class="generate-menu-section">
  <button class="btn-generate-menu" bindtap="generateTodayMenu">
    âœ¨ ç”Ÿæˆä»Šæ—¥èœå•
  </button>
</view>

<!-- ========== åŸèœå•æ˜¾ç¤ºåŒºåŸŸï¼ˆåªåœ¨éå€™é€‰æ± æ¨¡å¼ä¸”æœ‰èœå•æ—¶æ˜¾ç¤ºï¼‰ ========== -->
  
  <!-- A) æ‘˜è¦æ¨¡å¼ -->
  <view wx:if="{{!candidateMode && layoutMode === 'summary'}}" class="summary-layout">
    <view class="summary-card">
      <view class="summary-row" 
            wx:for="{{summaryData}}" 
            wx:key="mealName"
            bindtap="onSummaryRowTap"
            bindlongpress="onSummaryRowLongPress"
            data-section="{{item.section}}">
        <view class="row-content">
          <text class="meal-name">{{item.mealName}}</text>
          <text class="dish-text">{{item.dishText}}</text>
          <text class="time-text">Â· çº¦{{item.totalTime}}åˆ†é’Ÿ</text>
        </view>
        <text class="row-arrow">ï¼</text>
      </view>
      
      <view class="explain-card" wx:if="{{menuExplain}}">
        <text class="explain-icon">ğŸ’­</text>
        <text class="explain-text">{{menuExplain}}</text>
      </view>
    </view>
  </view>

  <!-- B) Walletæ¨ªæ»‘å¡ç‰‡ -->
  <view wx:if="{{!candidateMode && layoutMode === 'wallet'}}" class="wallet-layout">
    <swiper class="wallet-swiper" 
            current="{{currentCardIndex}}"
            bindchange="onWalletCardChange"
            display-multiple-items="1"
            previous-margin="24rpx"
            next-margin="24rpx">
      <swiper-item wx:for="{{walletCards}}" wx:key="mealName" class="wallet-slide">
        <view class="wallet-card" bindtap="onWalletCardTap">
          <view class="card-header">
            <text class="card-title">{{item.mealName}}</text>
            <text class="card-people">({{item.people}}ä½æˆäºº)</text>
            <view class="card-more" wx:if="{{item.hasMore}}">
              <text class="more-text">æŸ¥çœ‹å…¨éƒ¨ â–¸</text>
            </view>
          </view>
          <view class="card-dishes">
            <view class="card-dish" wx:for="{{item.dishes}}" wx:key="id" wx:for-item="dish">
              <text class="dish-emoji">{{dish.emoji}}</text>
              <text class="dish-name">{{dish.name}}</text>
            </view>
          </view>
          <view class="card-footer">
            <text class="total-time">å…±çº¦ {{item.totalTime}} åˆ†é’Ÿ</text>
          </view>
        </view>
      </swiper-item>
    </swiper>
    
    <view class="page-control">
      <view class="page-dot {{currentCardIndex === 0 ? 'active' : ''}}"></view>
      <view class="page-dot {{currentCardIndex === 1 ? 'active' : ''}}"></view>
    </view>
    
    <view class="explain-card" wx:if="{{menuExplain}}">
      <text class="explain-icon">ğŸ’­</text>
      <text class="explain-text">{{menuExplain}}</text>
    </view>
  </view>

  <!-- C) åˆ†æ®µæ§ä»¶Tabs -->
  <view wx:if="{{!candidateMode && layoutMode === 'tabs'}}" class="tabs-layout">
    <view class="tabs-control">
      <text class="tab-item {{tabsData.selectedTab === 'all' ? 'active' : ''}}"
            bindtap="onTabChange" data-tab="all">å…¨éƒ¨</text>
      <text class="tab-item {{tabsData.selectedTab === 'lunch' ? 'active' : ''}}"
            bindtap="onTabChange" data-tab="lunch">åˆé¤</text>
      <text class="tab-item {{tabsData.selectedTab === 'dinner' ? 'active' : ''}}"
            bindtap="onTabChange" data-tab="dinner">æ™šé¤</text>
    </view>
    
    <view class="tabs-content">
      <view class="meal-section" wx:for="{{tabsData.tabContent}}" wx:key="name">
        <view class="meal-header">
          <text class="meal-name">{{item.name}}</text>
          <text class="meal-people" wx:if="{{item.people}}">({{item.people}}ä½æˆäºº)</text>
        </view>
        <view class="dish-list">
          <view class="dish-item" wx:for="{{item.dishes}}" wx:key="id" wx:for-item="dish">
            <text class="dish-emoji">{{dish.emoji}}</text>
            <view class="dish-info">
              <text class="dish-name">{{dish.name}}</text>
              <text class="dish-meta">{{dish.time}}åˆ† Â· {{dish.costLabel}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="explain-card" wx:if="{{menuExplain}}">
        <text class="explain-icon">ğŸ’­</text>
        <text class="explain-text">{{menuExplain}}</text>
      </view>
    </view>
  </view>

  <!-- D) ç²¾è‡´åˆ—è¡¨ï¼ˆåŸç‰ˆå¸ƒå±€ï¼‰ -->
  <view wx:if="{{!candidateMode && layoutMode === 'detailList'}}" class="detail-layout">
    <view class="menu-content">
      <view class="meal-section" wx:for="{{todayMenu}}" wx:key="name">
        <view class="meal-header">
          <text class="meal-name">{{item.name}}</text>
          <text class="meal-people" wx:if="{{item.people}}">({{item.people}}ä½æˆäºº)</text>
        </view>
        <view class="dish-list">
          <view class="dish-item" wx:for="{{item.dishes}}" wx:key="id" wx:for-item="dish">
            <text class="dish-emoji">{{dish.emoji}}</text>
            <view class="dish-info">
              <text class="dish-name">{{dish.name}}</text>
              <text class="dish-meta">{{dish.time}}åˆ† Â· {{dish.costLabel}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="explain-card" wx:if="{{menuExplain}}">
        <text class="explain-icon">ğŸ’­</text>
        <text class="explain-text">{{menuExplain}}</text>
      </view>
    </view>
  </view>

  <!-- è¥å…»ç‚¹è¯„å¡ç‰‡ -->
  <view wx:if="{{!candidateMode && showNutritionComment && nutritionComment}}" class="nutrition-comment-card">
    <view class="comment-icon">âœ¨</view>
    <view class="comment-content">
      <text class="comment-title">è¥å…»ç‚¹è¯„</text>
      <text class="comment-text">{{nutritionComment}}</text>
    </view>
  </view>

  <!-- ========== V5.3 å€™é€‰æ± ç•Œé¢ ========== -->
  <view wx:if="{{candidateMode}}" class="candidate-pool-container">
    
    <!-- é¡¶éƒ¨æç¤º -->
    <view class="pool-header">
      <text class="header-title">ä»Šæ—¥èœå•å€™é€‰</text>
      <text class="header-subtitle">å‹¾é€‰ä½ å–œæ¬¢çš„èœå“ï¼ˆå·²é€‰{{selectedCount.total || 0}}é“ï¼‰</text>
    </view>

<!-- ========== è¤èœåŒº ========== -->
<view class="category-section">
  <view class="category-header">
    <view class="header-left">
      <text class="category-icon">ğŸ–</text>
      <text class="category-title">è¤èœ</text>
      <text class="category-count">å·²é€‰ {{selectedCount.meat || 0}} é“</text>
    </view>
    <button class="btn-replace-mini" bindtap="replaceCategory" data-type="meat">
      æ¢ä¸€æ‰¹
    </button>
  </view>
  
  <view class="dish-grid">
  <view 
    wx:for="{{candidatePool.meat}}" 
    wx:key="id"
    wx:for-item="dish"
    class="dish-card {{selectedDishes.meat && selectedDishes.meat.indexOf(dish.id) > -1 ? 'selected' : ''}}"
    bindtap="toggleDishSelection"
    data-type="meat"
    data-dish-id="{{dish.id}}"
  >
    <view class="dish-checkbox {{selectedDishes.meat && selectedDishes.meat.indexOf(dish.id) > -1 ? 'checked' : ''}}">
      <text wx:if="{{selectedDishes.meat && selectedDishes.meat.indexOf(dish.id) > -1}}" class="check-icon">âœ“</text>
    </view>
      
      <view class="dish-info">
        <text class="dish-name">{{dish.name}}</text>
        
        <view class="dish-meta">
          <text class="dish-time">â±ï¸ {{dish.time}}åˆ†é’Ÿ</text>
          <text wx:if="{{dish.style_tags && dish.style_tags.indexOf('æ´‹æ°”') > -1}}" class="dish-tag trendy">æ´‹æ°”</text>
        </view>
        
        <text class="dish-reason">{{dish.reason}}</text>
      </view>
    </view>
  </view>
</view>

<!-- ========== ç´ èœåŒº ========== -->
<view class="category-section">
  <view class="category-header">
    <view class="header-left">
      <text class="category-icon">ğŸ¥¬</text>
      <text class="category-title">ç´ èœ</text>
      <text class="category-count">å·²é€‰ {{selectedCount.veg || 0}} é“</text>
    </view>
    <button class="btn-replace-mini" bindtap="replaceCategory" data-type="veg">
      æ¢ä¸€æ‰¹
    </button>
  </view>
  
  <view class="dish-grid">
    <view 
      wx:for="{{candidatePool.veg}}" 
      wx:key="id"
      wx:for-item="dish"
      class="dish-card {{selectedDishes.veg.indexOf(dish.id) > -1 ? 'selected' : ''}}"
      bindtap="toggleDishSelection"
      data-type="veg"
      data-dish-id="{{dish.id}}"
    >
      <view class="dish-checkbox {{selectedDishes.veg.indexOf(dish.id) > -1 ? 'checked' : ''}}">
        <text wx:if="{{selectedDishes.veg.indexOf(dish.id) > -1}}" class="check-icon">â—</text>
      </view>
      
      <view class="dish-info">
        <text class="dish-name">{{dish.name}}</text>
        <view class="dish-meta">
          <text class="dish-time">â±ï¸ {{dish.time}}åˆ†é’Ÿ</text>
          <text wx:if="{{dish.style_tags && dish.style_tags.indexOf('æ´‹æ°”') > -1}}" class="dish-tag trendy">æ´‹æ°”</text>
        </view>
        <text class="dish-reason">{{dish.reason}}</text>
      </view>
    </view>
  </view>
</view>

<!-- ========== æ±¤å“åŒº ========== -->
<view class="category-section">
  <view class="category-header">
    <view class="header-left">
      <text class="category-icon">ğŸ²</text>
      <text class="category-title">æ±¤å“</text>
      <text class="category-count">å·²é€‰ {{selectedCount.soup || 0}} é“</text>
    </view>
    <button class="btn-replace-mini" bindtap="replaceCategory" data-type="soup">
      æ¢ä¸€æ‰¹
    </button>
  </view>
  
  <view class="dish-grid">
    <view 
      wx:for="{{candidatePool.soup}}" 
      wx:key="id"
      wx:for-item="dish"
      class="dish-card {{selectedDishes.soup.indexOf(dish.id) > -1 ? 'selected' : ''}}"
      bindtap="toggleDishSelection"
      data-type="soup"
      data-dish-id="{{dish.id}}"
    >
      <view class="dish-checkbox {{selectedDishes.soup.indexOf(dish.id) > -1 ? 'checked' : ''}}">
        <text wx:if="{{selectedDishes.soup.indexOf(dish.id) > -1}}" class="check-icon">â—</text>
      </view>
      
      <view class="dish-info">
        <text class="dish-name">{{dish.name}}</text>
        <view class="dish-meta">
          <text class="dish-time">â±ï¸ {{dish.time}}åˆ†é’Ÿ</text>
          <text wx:if="{{dish.style_tags && dish.style_tags.indexOf('æ´‹æ°”') > -1}}" class="dish-tag trendy">æ´‹æ°”</text>
        </view>
        <text class="dish-reason">{{dish.reason}}</text>
      </view>
    </view>
  </view>
</view>

<!-- ========== ä¸»é£ŸåŒº ========== -->
<view class="category-section">
  <view class="category-header">
    <view class="header-left">
      <text class="category-icon">ğŸš</text>
      <text class="category-title">ä¸»é£Ÿ</text>
      <text class="category-count">å·²é€‰ {{selectedCount.staple || 0}} é“</text>
    </view>
    <button class="btn-replace-mini" bindtap="replaceCategory" data-type="staple">
      æ¢ä¸€æ‰¹
    </button>
  </view>
  
  <view class="dish-grid">
    <view 
      wx:for="{{candidatePool.staple}}" 
      wx:key="id"
      wx:for-item="dish"
      class="dish-card {{selectedDishes.staple.indexOf(dish.id) > -1 ? 'selected' : ''}}"
      bindtap="toggleDishSelection"
      data-type="staple"
      data-dish-id="{{dish.id}}"
    >
      <view class="dish-checkbox {{selectedDishes.staple.indexOf(dish.id) > -1 ? 'checked' : ''}}">
        <text wx:if="{{selectedDishes.staple.indexOf(dish.id) > -1}}" class="check-icon">â—</text>
      </view>
      
      <view class="dish-info">
        <text class="dish-name">{{dish.name}}</text>
        <view class="dish-meta">
          <text class="dish-time">â±ï¸ {{dish.time}}åˆ†é’Ÿ</text>
          <text wx:if="{{dish.style_tags && dish.style_tags.indexOf('æ´‹æ°”') > -1}}" class="dish-tag trendy">æ´‹æ°”</text>
        </view>
        <text class="dish-reason">{{dish.reason}}</text>
      </view>
    </view>
  </view>
</view>

    <!-- åº•éƒ¨ç¡®è®¤æŒ‰é’® -->
    <view class="pool-footer">
      <button class="btn-confirm-large" bindtap="confirmSelection">
        âœ“ å®Œæˆé€‰æ‹©ï¼ˆå·²é€‰{{selectedCount.total || 0}}é“ï¼‰
      </button>
    </view>

  </view>
  <!-- å€™é€‰æ± ç•Œé¢ç»“æŸ -->

  <!-- ========== æœ€ç»ˆèœå•æ˜¾ç¤º ========== -->
  <view wx:if="{{!candidateMode && todayMenu.length > 0}}" class="final-menu-container">
    
    <view class="final-menu-header">
      <text class="menu-title">âœ“ ä»Šæ—¥èœå•</text>
      <text class="menu-count">å…± {{todayMenu.length}} é“èœ</text>
    </view>
    
    <view class="final-menu-list">
      <view wx:for="{{todayMenu}}" wx:key="id" class="final-dish-card">
        <view class="dish-main-info">
          <text class="dish-name">{{item.name}}</text>
          <text class="dish-course-tag">{{item.course}}</text>
        </view>
        
        <view class="dish-meta-info">
          <text class="meta-item">â± {{item.time}}åˆ†é’Ÿ</text>
          <text wx:if="{{item.tags && item.tags.length > 0}}" class="meta-tag">
            {{item.tags[0]}}
          </text>
        </view>
        
        <view wx:if="{{item.reason}}" class="dish-reason">
          <text>{{item.reason}}</text>
        </view>
      </view>
    </view>
    
    <view wx:if="{{nutritionComment}}" class="nutrition-comment-card">
      <view class="comment-icon">âœ¨</view>
      <view class="comment-content">
        <text class="comment-title">è¥å…»ç‚¹è¯„</text>
        <text class="comment-text">{{nutritionComment}}</text>
      </view>
    </view>
    
    <view class="final-menu-actions">
      <button class="btn-back-to-pool" bindtap="backToCandidates">
        â† è¿”å›å€™é€‰æ± 
      </button>
      <button class="btn-view-shopping" bindtap="showShoppingList">
        ğŸ“ æŸ¥çœ‹è´­ç‰©æ¸…å• ({{shoppingList.length}})
      </button>
    </view>
    
  </view>

  <!-- V4.0ä¸»è¦æŒ‰é’®åŒº -->
  <view class="primary-actions" wx:if="{{!candidateMode}}">
    <button class="action-btn role-primary" bindtap="handleRoleAction">
      {{roleConfig[userRole].actionText}}
    </button>
    
    <button class="action-btn secondary" bindtap="regenerateMenu">
      æ¢ä¸€æ¢
    </button>
    
    <button class="action-btn shopping" bindtap="showShoppingList">
      ğŸ“ è´­ç‰©æ¸…å• ({{shoppingList.length}})
    </button>
    
    <button class="action-btn success" bindtap="markMenuComplete">
      âœ“ ä»Šå¤©åšå®Œäº†
    </button>
  </view>

  <!-- æ™ºèƒ½ä»»åŠ¡åŒº -->
  <view class="task-section" wx:if="{{showTaskLayer && !candidateMode}}">
    <view class="task-card" 
          wx:for="{{smartTasks}}" 
          wx:key="title"
          bindtap="handleTaskAction" 
          data-action="{{item.tap}}">
      <view class="task-icon">{{item.icon}}</view>
      <view class="task-content">
        <text class="task-title">{{item.title}}</text>
        <text class="task-desc">{{item.desc}}</text>
      </view>
      <view class="task-action">
        <text class="action-text">{{item.action}}</text>
        <text class="arrow">â–¸</text>
      </view>
    </view>
  </view>

<!-- è´­ç‰©æ¸…å•å¼¹å±‚ -->
<view class="shopping-sheet-overlay" wx:if="{{showShoppingSheet}}" bindtap="closeShoppingSheet">
  <view class="shopping-sheet" catchtap="">
    <view class="sheet-header">
      <text class="sheet-title">ğŸ›’ è´­ç‰©æ¸…å•</text>
      <button class="sheet-close" bindtap="closeShoppingSheet">å®Œæˆ</button>
    </view>
    
    <scroll-view class="sheet-content" scroll-y="true">
      <view class="shopping-list" wx:if="{{shoppingList.length > 0}}">
        <view 
          class="shopping-item" 
          wx:for="{{shoppingList}}" 
          wx:key="name"
          catchtap="toggleShoppingItem"
          data-index="{{index}}"
        >
          <view class="item-checkbox {{item.checked ? 'checked' : ''}}">
            <text class="check-mark" wx:if="{{item.checked}}">âœ“</text>
          </view>
          <view class="item-info">
            <text class="item-name {{item.checked ? 'completed' : ''}}">{{item.name}}</text>
            <text class="item-amount">{{item.qty}}</text>
          </view>
          <text class="item-category">{{item.category}}</text>
        </view>
      </view>
      
      <view class="shopping-empty" wx:else>
        <text class="empty-icon">ğŸ›’</text>
        <text class="empty-text">æš‚æ— è´­ç‰©æ¸…å•</text>
      </view>
      
      <view class="sheet-actions" wx:if="{{shoppingList.length > 0}}">
        <button class="sheet-btn primary" bindtap="goBuyGroceries">
          å»ç¾å›¢ä¹°èœ
        </button>
      </view>
    </scroll-view>
  </view>
</view>

  <!-- èœå•è¯¦æƒ…å¼¹å±‚ -->
  <view class="menu-sheet-overlay" wx:if="{{showMenuSheet}}" bindtap="onSheetMaskTap">
    <view class="menu-sheet" bindtap="onSheetContentTap">
      <view class="sheet-header">
        <view class="sheet-handle"></view>
        <text class="sheet-title">ä»Šæ—¥å®Œæ•´èœå•</text>
        <view class="sheet-close" bindtap="closeMenuSheet">å®Œæˆ</view>
      </view>
      
      <scroll-view class="sheet-content" scroll-y="true">
        <view class="sheet-meal-section" wx:for="{{allMenuData}}" wx:key="name">
          <view class="sheet-meal-header">
            <text class="sheet-meal-title">{{item.name}}</text>
            <text class="sheet-meal-subtitle" wx:if="{{item.people}}">({{item.people}}ä½æˆäºº)</text>
          </view>
          
          <view class="sheet-dish-list">
            <view class="sheet-dish-item" wx:for="{{item.dishes}}" wx:key="id" wx:for-item="dish">
              <view class="sheet-dish-main">
                <text class="sheet-dish-emoji">{{dish.emoji}}</text>
                <view class="sheet-dish-info">
                  <text class="sheet-dish-name">{{dish.name}}</text>
                  <view class="sheet-dish-tags">
                    <text class="sheet-tag time">{{dish.time}}åˆ†</text>
                    <text class="sheet-tag cost">{{dish.costLabel}}</text>
                  </view>
                </view>
              </view>
              <button class="sheet-dish-replace" 
                      bindtap="replaceSingleDish" 
                      data-dish-id="{{dish.id}}" 
                      data-section="{{item.name}}">
                æ¢ä¸€é“
              </button>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>