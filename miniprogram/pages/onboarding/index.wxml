<view class="page">
  <!-- 头部 -->
  <view class="header">
    <view class="main-title">AI家庭管家 V3.0</view>
    <view class="subtitle">{{currentStep === 1 ? '让我了解你的家庭' : currentStep === 2 ? '饮食偏好设置' : '审美与语气'}}</view>
    <view class="progress-dots">
      <view class="dot {{currentStep >= 1 ? 'active' : ''}}"></view>
      <view class="dot {{currentStep >= 2 ? 'active' : ''}}"></view>
      <view class="dot {{currentStep >= 3 ? 'active' : ''}}"></view>
    </view>
  </view>

  <!-- 第1页：家庭基础 -->
  <view class="step-content {{currentStep === 1 ? 'active' : 'hidden'}}" wx:if="{{currentStep === 1}}">
    
    <!-- 城市位置 - 精简版 -->
    <view class="card compact">
      <view class="section-title-small">📍 城市位置</view>
      
      <!-- 自动定位状态 -->
      <view wx:if="{{locationStatus === 'pending'}}" class="location-status pending">
        <text class="status-icon">🔄</text>
        <text class="status-text">定位中...</text>
      </view>
      
      <!-- 定位成功 -->
      <view wx:elif="{{locationStatus === 'success'}}" class="location-status success">
        <view class="location-info">
          <text class="location-icon">📍</text>
          <text class="location-name">
            {{form.city.province || ''}}{{form.city.city || ''}}{{form.city.district || ''}}
          </text>
        </view>
        <text wx:if="{{form.autoLocation}}" class="location-tip">自动定位，如不对请点击下方更改</text>
      </view>
      
      <!-- 定位失败 -->
      <view wx:elif="{{locationStatus === 'failed'}}" class="location-status failed">
        <text class="status-icon">⚠️</text>
        <text class="status-text">定位失败，请手动选择</text>
      </view>
      
      <!-- 手动选择按钮 -->
      <picker mode="region" bindchange="onRegion" class="region-picker-compact">
        <view class="picker-btn-compact">
          <text class="picker-label">{{locationStatus === 'success' ? '重新选择' : '选择城市'}}</text>
          <text class="picker-arrow">›</text>
        </view>
      </picker>
    </view>

    <!-- 家庭成员结构 -->
    <view class="card">
      <view class="section-title">👥 家庭成员结构</view>
      <view class="family-grid">
        <view class="family-card {{form.familyType === 'single' ? 'active' : ''}}" 
              bindtap="onFamilyTypeSelect" data-value="single">
          <view class="family-emoji">🧑</view>
          <view class="family-text">单身</view>
        </view>
        <view class="family-card {{form.familyType === 'couple' ? 'active' : ''}}" 
              bindtap="onFamilyTypeSelect" data-value="couple">
          <view class="family-emoji">👫</view>
          <view class="family-text">夫妻二人</view>
        </view>
        <view class="family-card {{form.familyType === 'hasChild' ? 'active' : ''}}" 
              bindtap="onFamilyTypeSelect" data-value="hasChild">
          <view class="family-emoji">👨‍👩‍👧‍👦</view>
          <view class="family-text">有孩子</view>
        </view>
      </view>
      
      <!-- 单身：选择性别 -->
      <view wx:if="{{form.familyType === 'single'}}" class="sub-options">
        <view class="sub-title">性别</view>
        <view class="gender-options">
          <view class="option-btn {{form.gender === 'male' ? 'active' : ''}}" 
                bindtap="onGenderSelect" data-value="male">男</view>
          <view class="option-btn {{form.gender === 'female' ? 'active' : ''}}" 
                bindtap="onGenderSelect" data-value="female">女</view>
        </view>
      </view>
      
      <!-- 有孩子：数量和年龄 -->
      <view wx:if="{{form.familyType === 'hasChild'}}" class="sub-options">
        <view class="sub-title">孩子数量</view>
        <view class="count-options">
          <view class="option-btn {{form.childCount === 1 ? 'active' : ''}}" 
                bindtap="onChildCountSelect" data-value="1">1个</view>
          <view class="option-btn {{form.childCount === 2 ? 'active' : ''}}" 
                bindtap="onChildCountSelect" data-value="2">2个</view>
          <view class="option-btn {{form.childCount === 3 ? 'active' : ''}}" 
                bindtap="onChildCountSelect" data-value="3">3个</view>
          <view class="option-btn {{form.childCount === 4 ? 'active' : ''}}" 
                bindtap="onChildCountSelect" data-value="4">4个</view>
        </view>
        
        <!-- 孩子年龄滚动选择 -->
        <view wx:if="{{form.childCount > 0}}" class="children-details">
          <view wx:for="{{form.childrenInfo}}" wx:key="index" class="child-item">
            <view class="child-header">第{{index + 1}}个孩子</view>
            
            <view class="age-picker-container">
              <view class="age-display">
                年龄：{{item.years}}岁{{item.years <= 2 ? (item.months || 0) + '个月' : ''}}
              </view>
              
              <picker-view indicator-style="height: 50px;" 
                          style="width: 100%; height: 120px;" 
                          value="{{[item.years, item.years <= 2 ? (item.months || 1) - 1 : 0]}}"
                          bindchange="onChildAgeChange" 
                          data-index="{{index}}">
                <picker-view-column>
                  <view wx:for="{{childAgeOptions.years}}" wx:key="*this" class="picker-item">
                    {{item}}岁
                  </view>
                </picker-view-column>
                <picker-view-column wx:if="{{item.years <= 2}}">
                  <view wx:for="{{childAgeOptions.months}}" wx:key="*this" class="picker-item">
                    {{item}}个月
                  </view>
                </picker-view-column>
              </picker-view>
            </view>
            
            <!-- 性别选择 -->
            <view class="child-gender">
              <text class="gender-label">性别：</text>
              <view class="gender-options">
                <text class="gender-btn {{item.gender === 'boy' ? 'active' : ''}}"
                      bindtap="onChildGenderSelect" 
                      data-index="{{index}}" 
                      data-value="boy">男孩</text>
                <text class="gender-btn {{item.gender === 'girl' ? 'active' : ''}}"
                      bindtap="onChildGenderSelect" 
                      data-index="{{index}}" 
                      data-value="girl">女孩</text>
                <text class="gender-btn {{item.gender === 'skip' ? 'active' : ''}}"
                      bindtap="onChildGenderSelect" 
                      data-index="{{index}}" 
                      data-value="skip">跳过</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 家庭帮手 -->
    <view class="card">
      <view class="section-title">🏠 家里有人帮忙吗？</view>
      
      <view class="helper-list">
        <!-- 保姆 -->
        <view class="helper-item">
          <view class="helper-main">
            <view class="helper-info">
              <view class="helper-emoji">👩‍🍳</view>
              <text class="helper-name">保姆</text>
            </view>
            <switch checked="{{form.helpers.nanny.enabled}}" 
                   bindchange="onHelperToggle" 
                   data-type="nanny"/>
          </view>
          
          <view wx:if="{{form.helpers.nanny.enabled}}" class="helper-details">
            <view class="detail-row">
              <text class="detail-label required">数量：</text>
              <view class="count-options">
                <text class="option-btn {{form.helpers.nanny.count === 1 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="nanny" data-value="1">1个</text>
                <text class="option-btn {{form.helpers.nanny.count === 2 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="nanny" data-value="2">2个</text>
                <text class="option-btn {{form.helpers.nanny.count === 3 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="nanny" data-value="3">3个</text>
                <text class="option-btn {{form.helpers.nanny.count === 4 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="nanny" data-value="4">4个</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 钟点工 -->
        <view class="helper-item">
          <view class="helper-main">
            <view class="helper-info">
              <view class="helper-emoji">🧹</view>
              <text class="helper-name">钟点工</text>
            </view>
            <switch checked="{{form.helpers.cleaner.enabled}}" 
                   bindchange="onHelperToggle" 
                   data-type="cleaner"/>
          </view>
          
          <view wx:if="{{form.helpers.cleaner.enabled}}" class="helper-details">
            <view class="detail-row">
              <text class="detail-label required">数量：</text>
              <view class="count-options">
                <text class="option-btn {{form.helpers.cleaner.count === 1 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="cleaner" data-value="1">1个</text>
                <text class="option-btn {{form.helpers.cleaner.count === 2 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="cleaner" data-value="2">2个</text>
                <text class="option-btn {{form.helpers.cleaner.count === 3 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="cleaner" data-value="3">3个</text>
                <text class="option-btn {{form.helpers.cleaner.count === 4 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="cleaner" data-value="4">4个</text>
              </view>
            </view>
            
            <view class="detail-row">
              <text class="detail-label">出勤频率：</text>
              <view class="freq-options">
                <text wx:for="{{cleanerFrequencies}}" wx:key="*this"
                      class="option-btn {{form.helpers.cleaner.frequency === item ? 'active' : ''}}"
                      bindtap="onHelperFreqSelect" data-type="cleaner" data-value="{{item}}">{{item}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 司机 -->
        <view class="helper-item">
          <view class="helper-main">
            <view class="helper-info">
              <view class="helper-emoji">🚗</view>
              <text class="helper-name">司机</text>
            </view>
            <switch checked="{{form.helpers.driver.enabled}}" 
                   bindchange="onHelperToggle" 
                   data-type="driver"/>
          </view>
          
          <view wx:if="{{form.helpers.driver.enabled}}" class="helper-details">
            <view class="detail-row">
              <text class="detail-label required">数量：</text>
              <view class="count-options">
                <text class="option-btn {{form.helpers.driver.count === 1 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="driver" data-value="1">1个</text>
                <text class="option-btn {{form.helpers.driver.count === 2 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="driver" data-value="2">2个</text>
                <text class="option-btn {{form.helpers.driver.count === 3 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="driver" data-value="3">3个</text>
                <text class="option-btn {{form.helpers.driver.count === 4 ? 'active' : ''}}"
                      bindtap="onHelperCountSelect" data-type="driver" data-value="4">4个</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 自己搞定一切 -->
        <view class="helper-item">
          <view class="helper-main">
            <view class="helper-info">
              <view class="helper-emoji">✋</view>
              <text class="helper-name">自己搞定一切</text>
            </view>
            <switch checked="{{!hasAnyHelper}}" 
                   disabled="{{hasAnyHelper}}"
                   bindchange="onHelperToggle" 
                   data-type="selfHandle"/>
          </view>
        </view>
      </view>
    </view>

    <!-- 宠物 -->
    <view class="card">
      <view class="section-title">🐾 宠物</view>
      <view class="pet-main">
        <view class="pet-question">是否有宠物：</view>
        <switch checked="{{form.hasPet}}" bindchange="onPetToggle"/>
      </view>
    </view>
  </view>

  <!-- 第2页：饮食偏好 -->
  <view class="step-content {{currentStep === 2 ? 'active' : 'hidden'}}" wx:if="{{currentStep === 2}}">
    
    <!-- 🔥 新增：菜系偏好 -->
    <view class="card">
      <view class="section-title">🍜 菜系偏好（最多3个）</view>
      <view class="cuisine-hint">已选 {{form.cuisinePrefs.length}}/3</view>
      <view class="cuisine-grid">
        <view wx:for="{{cuisineOptions}}" wx:key="value"
              class="cuisine-tag {{selectedCuisinePrefs[item.value] ? 'active' : ''}}"
              bindtap="onCuisineToggle" 
              data-value="{{item.value}}">
          {{item.label}}
        </view>
      </view>
    </view>

    <!-- 饮食目标 -->
    <view class="card">
      <view class="section-title">🎯 饮食目标（可多选）</view>
      <view class="diet-goals-grid">
        <view wx:for="{{dietGoalOptions}}" wx:key="value"
              class="goal-card {{selectedDietGoals[item.value] ? 'active' : ''}}"
              bindtap="onDietGoalToggle" 
              data-value="{{item.value}}">
          <view class="goal-title">{{item.label}}</view>
          <view class="goal-desc">{{item.desc}}</view>
        </view>
      </view>
    </view>

    <!-- 口味偏好 -->
    <view class="card">
      <view class="section-title">🌶️ 口味偏好</view>
      
      <view class="taste-section">
        <view class="taste-label">偏好（可多选）：</view>
        <view class="taste-options">
          <text class="option-btn {{selectedTastePreferences['清淡'] ? 'active' : ''}}"
                bindtap="onTastePreferenceToggle" 
                data-value="清淡">清淡</text>
          <text class="option-btn {{selectedTastePreferences['微辣'] ? 'active' : ''}}"
                bindtap="onTastePreferenceToggle" 
                data-value="微辣">微辣</text>
          <text class="option-btn {{selectedTastePreferences['重口'] ? 'active' : ''}}"
                bindtap="onTastePreferenceToggle" 
                data-value="重口">重口</text>
        </view>
      </view>
      
      <view class="taste-section">
        <view class="taste-label">禁忌（可多选）：</view>
        <view class="taboo-options">
          <text class="option-btn {{selectedDietTaboos['不吃葱蒜'] ? 'active' : ''}}"
                bindtap="onTabooToggle" 
                data-value="不吃葱蒜">不吃葱蒜</text>
          <text class="option-btn {{selectedDietTaboos['不吃香菜'] ? 'active' : ''}}"
                bindtap="onTabooToggle" 
                data-value="不吃香菜">不吃香菜</text>
          <text class="option-btn {{selectedDietTaboos['不食海鲜'] ? 'active' : ''}}"
                bindtap="onTabooToggle" 
                data-value="不食海鲜">不食海鲜</text>
          <text class="option-btn {{selectedDietTaboos['乳制品不耐受'] ? 'active' : ''}}"
                bindtap="onTabooToggle" 
                data-value="乳制品不耐受">乳制品不耐受</text>
        </view>
        <input class="taboo-input" 
               placeholder="其他禁忌（≤20字）" 
               maxlength="20"
               bindinput="onTabooOtherInput"/>
      </view>
    </view>

    <!-- 饮食节奏 -->
    <view class="card">
      <view class="section-title">⏰ 饮食节奏</view>
      
      <view class="rhythm-row">
        <text class="rhythm-label">买菜频率：</text>
        <view class="rhythm-options">
          <text class="option-btn {{form.shoppingFreq === '每天' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="shoppingFreq" data-value="每天">每天</text>
          <text class="option-btn {{form.shoppingFreq === '隔天' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="shoppingFreq" data-value="隔天">隔天</text>
          <text class="option-btn {{form.shoppingFreq === '每周' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="shoppingFreq" data-value="每周">每周</text>
          <text class="option-btn {{form.shoppingFreq === '不固定' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="shoppingFreq" data-value="不固定">不固定</text>
        </view>
      </view>
      
      <view class="rhythm-row">
        <text class="rhythm-label">早餐时间：</text>
        <view class="rhythm-options">
          <text class="option-btn {{form.breakfastTime === '7:00-8:00' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="breakfastTime" data-value="7:00-8:00">7:00-8:00</text>
          <text class="option-btn {{form.breakfastTime === '8:00-9:00' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="breakfastTime" data-value="8:00-9:00">8:00-9:00</text>
          <text class="option-btn {{form.breakfastTime === '跳过' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="breakfastTime" data-value="跳过">跳过</text>
        </view>
      </view>
      
      <view class="rhythm-row">
        <text class="rhythm-label">晚餐时间：</text>
        <view class="rhythm-options">
          <text class="option-btn {{form.dinnerTime === '18:00-19:00' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="dinnerTime" data-value="18:00-19:00">18:00-19:00</text>
          <text class="option-btn {{form.dinnerTime === '19:00-20:00' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="dinnerTime" data-value="19:00-20:00">19:00-20:00</text>
          <text class="option-btn {{form.dinnerTime === '20:00+' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="dinnerTime" data-value="20:00+">20:00+</text>
        </view>
      </view>
      
      <view class="rhythm-row">
        <text class="rhythm-label">外食频率：</text>
        <view class="rhythm-options">
          <text class="option-btn {{form.diningOutFreq === '很少' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="diningOutFreq" data-value="很少">很少</text>
          <text class="option-btn {{form.diningOutFreq === '偶尔' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="diningOutFreq" data-value="偶尔">偶尔</text>
          <text class="option-btn {{form.diningOutFreq === '经常' ? 'active' : ''}}"
                bindtap="onRhythmSelect" data-field="diningOutFreq" data-value="经常">经常</text>
        </view>
      </view>
    </view>

    <!-- 预算档 -->
    <view class="card">
      <view class="section-title">💰 预算档次</view>
      <view class="budget-grid">
        <view class="budget-card {{form.budgetLevel === '实惠' ? 'active' : ''}}"
              bindtap="onBudgetSelect" data-value="实惠">
          <view class="budget-title">实惠</view>
          <view class="budget-desc">≤30/人</view>
        </view>
        <view class="budget-card {{form.budgetLevel === '小资' ? 'active' : ''}}"
              bindtap="onBudgetSelect" data-value="小资">
          <view class="budget-title">小资</view>
          <view class="budget-desc">40-80/人</view>
        </view>
        <view class="budget-card {{form.budgetLevel === '精致' ? 'active' : ''}}"
              bindtap="onBudgetSelect" data-value="精致">
          <view class="budget-title">精致</view>
          <view class="budget-desc">100+/人</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 第3页：审美语气 -->
  <view class="step-content {{currentStep === 3 ? 'active' : 'hidden'}}" wx:if="{{currentStep === 3}}">
    
    <!-- 生活风格 -->
    <view class="card">
      <view class="section-title">🎨 生活风格</view>
      <view class="style-grid">
        <view class="style-card {{form.lifeStyle === '实用派' ? 'active' : ''}}"
              bindtap="onLifeStyleSelect" data-value="实用派">
          <view class="style-icon">⚡</view>
          <view class="style-title">实用派</view>
          <view class="style-desc">清晰直接</view>
        </view>
        <view class="style-card {{form.lifeStyle === '小资生活' ? 'active' : ''}}"
              bindtap="onLifeStyleSelect" data-value="小资生活">
          <view class="style-icon">🌿</view>
          <view class="style-title">小资生活</view>
          <view class="style-desc">暖意 + 质感</view>
        </view>
        <view class="style-card {{form.lifeStyle === '精致控' ? 'active' : ''}}"
              bindtap="onLifeStyleSelect" data-value="精致控">
          <view class="style-icon">✨</view>
          <view class="style-title">精致控</view>
          <view class="style-desc">克制 + 高级</view>
        </view>
      </view>
    </view>

    <!-- AI语气偏好 -->
    <view class="card">
      <view class="section-title">🤖 AI语气偏好</view>
      <view class="tone-list">
        <view class="tone-card {{form.aiTone === '温柔陪伴' ? 'active' : ''}}"
              bindtap="onAiToneSelect" data-value="温柔陪伴">
          <view class="tone-title">温柔陪伴</view>
          <view class="tone-sample">"慢一点，生活会更好。"</view>
        </view>
        <view class="tone-card {{form.aiTone === '干练高效' ? 'active' : ''}}"
              bindtap="onAiToneSelect" data-value="干练高效">
          <view class="tone-title">干练高效</view>
          <view class="tone-sample">"3道菜，30分钟搞定。"</view>
        </view>
        <view class="tone-card {{form.aiTone === '幽默轻松' ? 'active' : ''}}"
              bindtap="onAiToneSelect" data-value="幽默轻松">
          <view class="tone-title">幽默轻松</view>
          <view class="tone-sample">"今天吃得健康，快乐加倍。"</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部按钮 -->
  <view class="bottom-actions">
    <button wx:if="{{currentStep > 1}}" class="btn-secondary" bindtap="prevStep">上一步</button>
    <button wx:if="{{currentStep < 3}}" class="btn-primary" bindtap="nextStep">
      {{currentStep === 1 ? '下一步 · 饮食偏好' : '下一步 · 审美与语气'}}
    </button>
    <button wx:if="{{currentStep === 3}}" class="btn-primary" bindtap="onDone">🎉 进入</button>
  </view>
</view>