<!-- pages/reports/reflection/index.wxml - V4.2 æ¯æ—¥å¤ç›˜é¡µé¢ -->
<view class="reflection-page">
  
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="page-header">
    <view class="header-title">æ¯æ—¥å¤ç›˜</view>
    <view class="header-subtitle">äº†è§£ä½¿ç”¨ä¹ æƒ¯ï¼ŒæŒç»­æ”¹è¿›æå‡</view>
  </view>

  <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
  <view class="tabs-container">
    <view class="tab-item {{currentTab === 'today' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="today">
      <text class="tab-text">ä»Šæ—¥å¤ç›˜</text>
    </view>
    <view class="tab-item {{currentTab === 'week' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="week">
      <text class="tab-text">æœ¬å‘¨æ€»ç»“</text>
    </view>
    <view class="tab-item {{currentTab === 'history' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="history">
      <text class="tab-text">å†å²è®°å½•</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-icon"></view>
    <text class="loading-text">ç”Ÿæˆå¤ç›˜ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{empty}}" class="empty-container">
    <view class="empty-icon">ğŸ“</view>
    <text class="empty-title">æš‚æ— å¤ç›˜æ•°æ®</text>
    <text class="empty-desc">
      {{currentTab === 'today' ? 'ä»Šå¤©è¿˜æ²¡æœ‰è¶³å¤Ÿçš„ä½¿ç”¨æ•°æ®' : 
        currentTab === 'week' ? 'æœ¬å‘¨ä½¿ç”¨æ•°æ®ä¸è¶³' : 'æš‚æ— å†å²è®°å½•'}}
    </text>
    <button class="btn-refresh" bindtap="regenerateReflection">é‡æ–°ç”Ÿæˆ</button>
  </view>

  <!-- ä»Šæ—¥å¤ç›˜å†…å®¹ -->
  <view wx:elif="{{currentTab === 'today' && todayReflection}}" class="content-container">
    
    <!-- æ´»è·ƒåº¦å¡ç‰‡ -->
    <view class="activity-card">
      <view class="activity-header">
        <view class="activity-left">
          <text class="activity-date">{{todayReflection.date}}</text>
          <text class="activity-label">ä»Šæ—¥æ´»è·ƒåº¦</text>
        </view>
        <view class="activity-right">
          <text class="activity-score">{{todayReflection.activityScore}}</text>
          <text class="activity-unit">åˆ†</text>
        </view>
      </view>
      <view class="activity-bar">
        <view class="activity-progress" style="width: {{todayReflection.activityScore + '%'}}"></view>
      </view>
    </view>

    <!-- AI æ€»ç»“ -->
    <view class="summary-card">
      <view class="card-header">
        <text class="card-title">AI å¤ç›˜æ€»ç»“</text>
        <view class="ai-badge">{{userProfile.ai_tone || 'æ¸©æŸ”'}}è¯­æ°”</view>
      </view>
      <view class="summary-content">
        <text class="summary-text">{{todayReflection.summary}}</text>
      </view>
    </view>

    <!-- æ´å¯Ÿåˆ†æ -->
    <view class="insights-card" wx:if="{{todayReflection.insights.length > 0}}">
      <view class="card-header">
        <text class="card-title">ä»Šæ—¥æ´å¯Ÿ</text>
      </view>
      <view class="insights-list">
        <view class="insight-item" wx:for="{{todayReflection.insights}}" wx:key="*this">
          <view class="insight-icon">ğŸ’¡</view>
          <text class="insight-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- æ”¹è¿›å»ºè®® -->
    <view class="suggestions-card" wx:if="{{todayReflection.suggestions.length > 0}}">
      <view class="card-header">
        <text class="card-title">æ”¹è¿›å»ºè®®</text>
      </view>
      <view class="suggestions-list">
        <view class="suggestion-item" wx:for="{{todayReflection.suggestions}}" wx:key="*this">
          <view class="suggestion-icon">ğŸ¯</view>
          <text class="suggestion-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="btn-secondary" bindtap="shareReflection">åˆ†äº«å¤ç›˜</button>
      <button class="btn-primary" bindtap="regenerateReflection">é‡æ–°ç”Ÿæˆ</button>
    </view>
  </view>

  <!-- æœ¬å‘¨å¤ç›˜å†…å®¹ -->
  <view wx:elif="{{currentTab === 'week' && weeklyReflection}}" class="content-container">
    
    <!-- å‘¨æ¦‚è§ˆ -->
    <view class="week-overview-card">
      <view class="week-header">
        <text class="week-title">æœ¬å‘¨æ¦‚è§ˆ</text>
        <text class="week-period">{{weeklyReflection.weekStart}} ~ {{weeklyReflection.weekEnd}}</text>
      </view>
      <view class="week-stats">
        <view class="stat-item">
          <text class="stat-number">{{weeklyReflection.stats.activeDays}}</text>
          <text class="stat-label">æ´»è·ƒå¤©æ•°</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{weeklyReflection.stats.avgActivityScore}}</text>
          <text class="stat-label">å¹³å‡æ´»è·ƒåº¦</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{weeklyReflection.stats.totalInteractions}}</text>
          <text class="stat-label">æ€»äº’åŠ¨æ¬¡æ•°</text>
        </view>
      </view>
    </view>

    <!-- å‘¨æ€»ç»“ -->
    <view class="summary-card">
      <view class="card-header">
        <text class="card-title">æœ¬å‘¨æ€»ç»“</text>
        <view class="ai-badge">{{userProfile.ai_tone || 'æ¸©æŸ”'}}è¯­æ°”</view>
      </view>
      <view class="summary-content">
        <text class="summary-text">{{weeklyReflection.summary}}</text>
      </view>
    </view>

    <!-- å‘¨æ´å¯Ÿ -->
    <view class="insights-card" wx:if="{{weeklyReflection.insights.length > 0}}">
      <view class="card-header">
        <text class="card-title">æœ¬å‘¨æ´å¯Ÿ</text>
      </view>
      <view class="insights-list">
        <view class="insight-item" wx:for="{{weeklyReflection.insights}}" wx:key="*this">
          <view class="insight-icon">ğŸ“Š</view>
          <text class="insight-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- å‘¨å»ºè®® -->
    <view class="suggestions-card" wx:if="{{weeklyReflection.suggestions.length > 0}}">
      <view class="card-header">
        <text class="card-title">ä¸‹å‘¨å»ºè®®</text>
      </view>
      <view class="suggestions-list">
        <view class="suggestion-item" wx:for="{{weeklyReflection.suggestions}}" wx:key="*this">
          <view class="suggestion-icon">ğŸš€</view>
          <text class="suggestion-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- æ¯æ—¥æ˜ç»† -->
    <view class="daily-details" wx:if="{{weeklyReflection.dailyData.length > 0}}">
      <view class="card-header">
        <text class="card-title">æ¯æ—¥æ˜ç»†</text>
      </view>
      <view class="daily-list">
        <view class="daily-item" wx:for="{{weeklyReflection.dailyData}}" wx:key="date">
          <view class="daily-left">
            <text class="daily-name">{{item.dayName}}</text>
            <text class="daily-date">{{item.date}}</text>
          </view>
          <view class="daily-right">
            <text class="daily-interactions">{{item.interactions}}æ¬¡äº’åŠ¨</text>
            <view class="daily-score">{{item.activityScore || 0}}åˆ†</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="btn-secondary" bindtap="shareReflection">åˆ†äº«æ€»ç»“</button>
      <button class="btn-primary" bindtap="regenerateReflection">é‡æ–°ç”Ÿæˆ</button>
    </view>
  </view>

  <!-- å†å²è®°å½•å†…å®¹ -->
  <view wx:elif="{{currentTab === 'history' && historyData.length > 0}}" class="content-container">
    
    <!-- å†å²è¶‹åŠ¿ -->
    <view class="history-card">
      <view class="card-header">
        <text class="card-title">æœ€è¿‘æ´»è·ƒåº¦è¶‹åŠ¿</text>
        <text class="card-subtitle">è¿‘14å¤©è®°å½•</text>
      </view>
      <view class="history-list">
        <view class="history-item" wx:for="{{historyData}}" wx:key="date" 
              bindtap="viewDayReflection" data-date="{{item.date}}">
          <view class="history-left">
            <text class="history-date">{{item.dateDisplay}}</text>
            <text class="history-meta">{{item.interactions}}æ¬¡äº’åŠ¨</text>
          </view>
          <view class="history-right">
            <view class="history-score-container">
              <text class="history-score" style="color: {{item.scoreColor}}">{{item.score}}</text>
              <text class="history-level" style="color: {{item.scoreColor}}">{{item.scoreLevel}}</text>
            </view>
            <view class="history-arrow">></view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <view class="stats-overview">
      <view class="card-header">
        <text class="card-title">ä½¿ç”¨ç»Ÿè®¡</text>
      </view>
      <view class="overview-stats">
        <view class="overview-item">
          <text class="overview-number">{{historyData.length}}</text>
          <text class="overview-label">æ´»è·ƒå¤©æ•°</text>
        </view>
        <view class="overview-item">
          <text class="overview-number">{{averageScore}}</text>
          <text class="overview-label">å¹³å‡æ´»è·ƒåº¦</text>
        </view>
        <view class="overview-item">
          <text class="overview-number">{{totalInteractions}}</text>
          <text class="overview-label">æ€»äº’åŠ¨æ¬¡æ•°</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å·¥å…·æ  -->
  <view class="bottom-toolbar" wx:if="{{!loading && !empty}}">
    <button class="tool-btn" bindtap="showGuide">
      <text class="tool-icon">â“</text>
      <text class="tool-text">ä½¿ç”¨æŒ‡å—</text>
    </button>
    <button class="tool-btn" bindtap="shareReflection">
      <text class="tool-icon">ğŸ“¤</text>
      <text class="tool-text">åˆ†äº«</text>
    </button>
  </view>

</view>