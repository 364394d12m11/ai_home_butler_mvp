<!-- components/dialog-ai/index.wxml -->
<view class="dialog-mask" wx:if="{{show}}" catchtap="onMaskTap">
  <view class="dialog-container" catchtap="">
    
    <!-- å¯¹è¯å†å² -->
    <scroll-view class="messages" scroll-y scroll-into-view="msg-{{messages.length-1}}">
      <view 
        wx:for="{{messages}}" 
        wx:key="index"
        id="msg-{{index}}"
        class="message {{item.role}}">
        <view class="message-content">
          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <image wx:if="{{item.meta.type === 'image'}}" 
                 src="{{item.meta.url}}" 
                 mode="aspectFill" 
                 class="message-image" />
          
<!-- è¯­éŸ³æ¶ˆæ¯ -->
<view wx:elif="{{item.meta.type === 'voice'}}" 
      class="voice-message {{item.meta.playing ? 'playing' : ''}}"
      bindtap="toggleVoicePlay"
      bindlongpress="showVoiceMenu"
      data-index="{{index}}">
  
  <!-- è¯­éŸ³åŠ¨ç”» -->
  <view class="voice-animation">
    <view class="wave {{item.meta.playing ? 'active' : ''}}"></view>
    <view class="wave {{item.meta.playing ? 'active' : ''}}"></view>
    <view class="wave {{item.meta.playing ? 'active' : ''}}"></view>
  </view>
  
  <!-- æ—¶é•¿ -->
  <text class="voice-duration">{{item.meta.duration || 1}}"</text>
  
  <!-- æ’­æ”¾è¿›åº¦ï¼ˆæ’­æ”¾æ—¶æ˜¾ç¤ºï¼‰ -->
  <text wx:if="{{item.meta.playing}}" class="voice-progress">
    {{item.meta.currentTime || 0}}"
  </text>
  
  <!-- å€é€Ÿæ ‡è¯†ï¼ˆ>10ç§’ä¸”å·²è®¾ç½®å€é€Ÿï¼‰ -->
  <text wx:if="{{item.meta.duration > 10 && item.meta.playbackRate > 1}}" 
        class="voice-speed">
    {{item.meta.playbackRate}}x
  </text>
  
  <!-- æœªå¬æ ‡è¯† -->
  <view wx:if="{{!item.meta.listened}}" class="unread-dot"></view>
</view>
          
          <!-- æ–‡å­—æ¶ˆæ¯ -->
          <text wx:else>{{item.content}}</text>
        </view>
      </view>
      
      <view wx:if="{{processing}}" class="message assistant typing">
        <view class="typing-indicator">
          <view></view><view></view><view></view>
        </view>
      </view>
    </scroll-view>
    
    <!-- è¾“å…¥åŒº - å¾®ä¿¡é£æ ¼ -->
    <view class="input-area-wechat">
      
      <!-- å·¦ä¾§ï¼šè¯­éŸ³æŒ‰é’® -->
      <view class="left-actions">
        <view class="icon-btn" bindtap="toggleVoiceMode">
          <text>{{isVoiceMode ? 'âŒ¨ï¸' : 'ğŸ¤'}}</text>
        </view>
      </view>
      
      <!-- ä¸­é—´ï¼šè¾“å…¥æ¡† æˆ– è¯­éŸ³æŒ‰é’® -->
      <view class="input-main">
        <!-- æ–‡æœ¬è¾“å…¥æ¨¡å¼ -->
        <input 
          wx:if="{{!isVoiceMode}}"
          class="text-input" 
          value="{{inputText}}"
          placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
          bindinput="onInputChange"
          confirm-type="send"
          bindconfirm="sendText"
          adjust-position="{{true}}"
        />
        
        <!-- è¯­éŸ³è¾“å…¥æ¨¡å¼ -->
        <button 
          wx:else
          class="voice-btn {{recording ? 'recording' : ''}}"
          bindtouchstart="startRecord"
          bindtouchend="stopRecord"
          bindtouchcancel="stopRecord">
          {{recording ? 'æ¾å¼€ ç»“æŸ' : 'æŒ‰ä½ è¯´è¯'}}
        </button>
      </view>
      
      <!-- å³ä¾§ï¼šç›¸å†Œ/æ‹ç…§/å‘é€ -->
      <view class="right-actions">
        
        <!-- æœ‰æ–‡å­—æ—¶æ˜¾ç¤ºå‘é€æŒ‰é’® -->
        <view wx:if="{{inputText}}" class="send-btn" bindtap="sendText">
          å‘é€
        </view>
        
        <!-- æ²¡æ–‡å­—æ—¶æ˜¾ç¤ºç›¸å†Œå’Œæ‹ç…§ -->
        <view wx:else class="media-actions">
          <!-- ç›¸å†Œ -->
          <view class="icon-btn" bindtap="chooseFromAlbum">
            <text>ğŸ–¼ï¸</text>
          </view>
          <!-- æ‹ç…§ -->
          <view class="icon-btn" bindtap="takePhoto">
            <text>ğŸ“·</text>
          </view>
        </view>
        
      </view>
      
    </view>
    
  </view>
</view>